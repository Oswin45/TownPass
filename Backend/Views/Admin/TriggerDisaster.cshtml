@{
    ViewData["Title"] = "Disaster Trigger";
}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4">
            <i class="bi bi-exclamation-triangle-fill text-danger"></i> ç½å®³äº‹ä»¶è§¸ç™¼
        </h1>
        <p class="lead">å»ºç«‹ç½å®³äº‹ä»¶ä¸¦ç™¼é€æ¨æ’­é€šçŸ¥çµ¦å·²è¨»å†Šçš„è£ç½®</p>
    </div>
</div>

<div class="row">
    <!-- Trigger Form -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> è§¸ç™¼æ–°ç½å®³äº‹ä»¶</h5>
            </div>
            <div class="card-body">
                <form id="disasterForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">ç½å®³æ¨™é¡Œ *</label>
                        <input type="text" class="form-control" id="title" placeholder="ä¾‹ï¼šåœ°éœ‡è­¦å ±" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">ç½å®³æè¿° *</label>
                        <textarea class="form-control" id="description" rows="3" placeholder="ä¾‹ï¼šå°åŒ—å¸‚ç™¼ç”Ÿè¦æ¨¡5.6åœ°éœ‡ï¼Œè«‹æ³¨æ„å®‰å…¨" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="latitude" class="form-label">ç·¯åº¦ (Latitude) *</label>
                            <input type="number" class="form-control" id="latitude" step="0.000001" placeholder="25.0330" required>
                            <small class="form-text text-muted">ç¯„åœï¼š-90 åˆ° 90</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="longitude" class="form-label">ç¶“åº¦ (Longitude) *</label>
                            <input type="number" class="form-control" id="longitude" step="0.000001" placeholder="121.5654" required>
                            <small class="form-text text-muted">ç¯„åœï¼š-180 åˆ° 180</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tags" class="form-label">æ¨™ç±¤</label>
                        <input type="text" class="form-control" id="tags" placeholder="earthquake,emergency">
                        <small class="form-text text-muted">å¤šå€‹æ¨™ç±¤ä»¥é€—è™Ÿåˆ†éš”</small>
                    </div>

                    <div class="mb-3">
                        <label for="imageFile" class="form-label">ç½å®³åœ–ç‰‡</label>
                        <input type="file" class="form-control" id="imageFile" accept="image/*">
                        <small class="form-text text-muted">é¸æ“‡æ€§ä¸Šå‚³åœ–ç‰‡ï¼ˆå°‡è‡ªå‹•è½‰ç‚º Base64ï¼‰</small>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="sendNotification" checked>
                        <label class="form-check-label" for="sendNotification">
                            ç™¼é€æ¨æ’­é€šçŸ¥
                        </label>
                    </div>

                    <div class="mb-3" id="radiusSection">
                        <label for="notificationRadius" class="form-label">é€šçŸ¥åŠå¾‘ï¼ˆå…¬é‡Œï¼‰</label>
                        <input type="number" class="form-control" id="notificationRadius" step="0.1" placeholder="ç•™ç©ºè¡¨ç¤ºé€šçŸ¥æ‰€æœ‰è£ç½®">
                        <small class="form-text text-muted">è¨­å®šå¾Œåƒ…é€šçŸ¥æŒ‡å®šåŠå¾‘å…§çš„è£ç½®</small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="bi bi-broadcast"></i> è§¸ç™¼ç½å®³äº‹ä»¶
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="bi bi-arrow-counterclockwise"></i> é‡è¨­è¡¨å–®
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Location Presets -->
        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="bi bi-geo-alt"></i> å¿«é€Ÿä½ç½®</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="setLocation(25.0330, 121.5654, 'å°åŒ—å¸‚')">
                        ğŸ“ å°åŒ—å¸‚æ”¿åºœ
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setLocation(24.1477, 120.6736, 'å°ä¸­å¸‚')">
                        ğŸ“ å°ä¸­å¸‚æ”¿åºœ
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setLocation(22.6273, 120.3014, 'é«˜é›„å¸‚')">
                        ğŸ“ é«˜é›„å¸‚æ”¿åºœ
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="getCurrentLocation()">
                        <i class="bi bi-crosshair"></i> ä½¿ç”¨ç•¶å‰ä½ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status and Registered Devices -->
    <div class="col-lg-6 mb-4">
        <!-- Result Display -->
        <div class="card mb-3" id="resultCard" style="display:none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> åŸ·è¡Œçµæœ</h5>
            </div>
            <div class="card-body" id="resultContent">
            </div>
        </div>

        <!-- Registered Devices -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-phone"></i> å·²è¨»å†Šè£ç½®</h5>
            </div>
            <div class="card-body" id="devicesContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨è¼‰å…¥è£ç½®æ¸…å–®...</p>
                </div>
            </div>
        </div>

        <!-- Test Notification -->
        <div class="card mt-3">
            <div class="card-header bg-warning">
                <h6 class="mb-0"><i class="bi bi-bell"></i> æ¸¬è©¦æ¨æ’­é€šçŸ¥</h6>
            </div>
            <div class="card-body">
                <p class="mb-2">ç™¼é€æ¸¬è©¦é€šçŸ¥åˆ°ç¬¬ä¸€å€‹å•Ÿç”¨çš„è£ç½®</p>
                <button class="btn btn-warning w-100" onclick="sendTestNotification()">
                    <i class="bi bi-send"></i> ç™¼é€æ¸¬è©¦é€šçŸ¥
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Recent Disasters -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> æœ€è¿‘ç½å®³äº‹ä»¶</h5>
            </div>
            <div class="card-body" id="recentDisasters">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨è¼‰å…¥ç½å®³äº‹ä»¶...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            loadRegisteredDevices();
            loadRecentDisasters();

            // Toggle radius input based on notification checkbox
            $('#sendNotification').change(function() {
                $('#radiusSection').toggle(this.checked);
            });
        });

        // Handle form submission
        $('#disasterForm').submit(async function(e) {
            e.preventDefault();

            const imageFile = document.getElementById('imageFile').files[0];
            let imageBase64 = null;

            // Convert image to base64 if selected
            if (imageFile) {
                try {
                    imageBase64 = await fileToBase64(imageFile);
                } catch (error) {
                    showError('åœ–ç‰‡è½‰æ›å¤±æ•—: ' + error);
                    return;
                }
            }

            const tags = $('#tags').val().trim() 
                ? $('#tags').val().split(',').map(t => t.trim()).filter(t => t)
                : ['emergency'];

            const data = {
                title: $('#title').val(),
                description: $('#description').val(),
                latitude: parseFloat($('#latitude').val()),
                longitude: parseFloat($('#longitude').val()),
                tags: tags,
                imageBase64: imageBase64,
                sendNotification: $('#sendNotification').is(':checked'),
                notificationRadiusKm: $('#notificationRadius').val() ? parseFloat($('#notificationRadius').val()) : null
            };

            // Show loading
            Swal.fire({
                title: 'è™•ç†ä¸­...',
                html: 'æ­£åœ¨è§¸ç™¼ç½å®³äº‹ä»¶',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '/api/Notification/TriggerDisaster',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    Swal.close();
                    showSuccess(response);
                    loadRecentDisasters();
                    loadRegisteredDevices();
                },
                error: function(xhr, status, error) {
                    Swal.close();
                    showError(xhr.responseJSON?.message || error);
                }
            });
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function loadRegisteredDevices() {
            $.ajax({
                url: '/api/Notification/RegisteredDevices?activeOnly=true',
                method: 'GET',
                success: function(response) {
                    displayDevices(response);
                },
                error: function(xhr, status, error) {
                    $('#devicesContent').html(`
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> è¼‰å…¥å¤±æ•—: ${error}
                        </div>
                    `);
                }
            });
        }

        function displayDevices(response) {
            const devices = response.data;
            
            if (devices.length === 0) {
                $('#devicesContent').html(`
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i> ç›®å‰æ²’æœ‰å·²è¨»å†Šçš„è£ç½®
                    </div>
                `);
                return;
            }

            let html = `
                <p class="mb-2"><strong>ç¸½è¨ˆ: ${response.count} å€‹è£ç½®</strong></p>
                <div class="list-group">
            `;

            devices.forEach(device => {
                const platformIcon = device.platform === 'Android' ? 'android2' : 'apple';
                const date = new Date(device.updatedAt).toLocaleString('zh-TW');
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                                <i class="bi bi-${platformIcon}"></i> ${device.platform || 'Unknown'}
                            </h6>
                            <small>${date}</small>
                        </div>
                        <p class="mb-1"><small>Device ID: ${device.deviceId || 'N/A'}</small></p>
                        <small class="text-muted">Token: ${device.tokenPreview}</small>
                    </div>
                `;
            });

            html += '</div>';
            $('#devicesContent').html(html);
        }

        function loadRecentDisasters() {
            $.ajax({
                url: '/api/DisasterEvent?limit=5',
                method: 'GET',
                success: function(response) {
                    displayRecentDisasters(response);
                },
                error: function(xhr, status, error) {
                    $('#recentDisasters').html(`
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> è¼‰å…¥å¤±æ•—: ${error}
                        </div>
                    `);
                }
            });
        }

        function displayRecentDisasters(response) {
            const disasters = response.data || [];
            
            if (disasters.length === 0) {
                $('#recentDisasters').html(`
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> ç›®å‰æ²’æœ‰ç½å®³äº‹ä»¶è¨˜éŒ„
                    </div>
                `);
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
            html += '<thead><tr><th>æ¨™é¡Œ</th><th>ä½ç½®</th><th>æ¨™ç±¤</th><th>å»ºç«‹æ™‚é–“</th></tr></thead><tbody>';

            disasters.forEach(disaster => {
                const date = new Date(disaster.createdAt).toLocaleString('zh-TW');
                const tags = disaster.tags.map(t => `<span class="badge bg-secondary">${t}</span>`).join(' ');
                
                html += `
                    <tr>
                        <td><strong>${disaster.title}</strong><br><small class="text-muted">${disaster.description.substring(0, 50)}...</small></td>
                        <td><small>${disaster.lat.toFixed(4)}, ${disaster.lnt.toFixed(4)}</small></td>
                        <td>${tags}</td>
                        <td><small>${date}</small></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            $('#recentDisasters').html(html);
        }

        function showSuccess(response) {
            const data = response.data;
            
            $('#resultCard').show();
            $('#resultContent').html(`
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle"></i> ${response.message}</h5>
                </div>
                <dl class="row mb-0">
                    <dt class="col-sm-4">ç½å®³ ID:</dt>
                    <dd class="col-sm-8"><code>${data.disasterId}</code></dd>
                    
                    <dt class="col-sm-4">æ¨™é¡Œ:</dt>
                    <dd class="col-sm-8">${data.title}</dd>
                    
                    <dt class="col-sm-4">ä½ç½®:</dt>
                    <dd class="col-sm-8">${data.latitude}, ${data.longitude}</dd>
                    
                    <dt class="col-sm-4">é€šçŸ¥æ•¸é‡:</dt>
                    <dd class="col-sm-8"><strong class="text-success">${data.notificationsSent}</strong> å‰‡æ¨æ’­é€šçŸ¥</dd>
                    
                    <dt class="col-sm-4">å»ºç«‹æ™‚é–“:</dt>
                    <dd class="col-sm-8">${new Date(data.createdAt).toLocaleString('zh-TW')}</dd>
                </dl>
            `);

            // Show sweet alert
            Swal.fire({
                icon: 'success',
                title: 'ç½å®³äº‹ä»¶å·²è§¸ç™¼',
                html: `<p>å·²æˆåŠŸç™¼é€ <strong>${data.notificationsSent}</strong> å‰‡æ¨æ’­é€šçŸ¥</p>`,
                confirmButtonColor: '#28a745'
            });

            // Scroll to result
            $('html, body').animate({
                scrollTop: $('#resultCard').offset().top - 20
            }, 500);
        }

        function showError(message) {
            $('#resultCard').show();
            $('#resultContent').html(`
                <div class="alert alert-danger">
                    <h5><i class="bi bi-x-circle"></i> ç™¼ç”ŸéŒ¯èª¤</h5>
                    <p class="mb-0">${message}</p>
                </div>
            `);

            Swal.fire({
                icon: 'error',
                title: 'è§¸ç™¼å¤±æ•—',
                text: message,
                confirmButtonColor: '#dc3545'
            });
        }

        function setLocation(lat, lng, name) {
            $('#latitude').val(lat);
            $('#longitude').val(lng);
            
            Swal.fire({
                icon: 'success',
                title: 'ä½ç½®å·²è¨­å®š',
                text: name,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                Swal.fire('éŒ¯èª¤', 'ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½', 'error');
                return;
            }

            Swal.fire({
                title: 'å–å¾—ä½ç½®ä¸­...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    $('#latitude').val(position.coords.latitude);
                    $('#longitude').val(position.coords.longitude);
                    Swal.fire({
                        icon: 'success',
                        title: 'ä½ç½®å·²å–å¾—',
                        text: `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`,
                        timer: 2000
                    });
                },
                function(error) {
                    Swal.fire('éŒ¯èª¤', 'ç„¡æ³•å–å¾—ä½ç½®: ' + error.message, 'error');
                }
            );
        }

        function resetForm() {
            $('#disasterForm')[0].reset();
            $('#resultCard').hide();
        }

        function sendTestNotification() {
            Swal.fire({
                title: 'ç™¼é€æ¸¬è©¦é€šçŸ¥...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '/api/Notification/TestNotification',
                method: 'POST',
                success: function(response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'æ¸¬è©¦é€šçŸ¥å·²ç™¼é€',
                        text: response.message
                    });
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ç™¼é€å¤±æ•—',
                        text: xhr.responseJSON?.message || error
                    });
                }
            });
        }
    </script>
}
